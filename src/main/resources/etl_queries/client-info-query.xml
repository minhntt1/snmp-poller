<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
    <entry key="addUndefinedVendorDim">
        <![CDATA[
            insert ignore into vendor_dim (vendor_key,vendor_name,vendor_prefix) values(
                -2147483648,
                '<undefined>',
                -2147483648
            );
        ]]>
    </entry>
    <entry key="addUndefinedApDim">
        <![CDATA[
            insert ignore into ap_dim(ap_key,ap_mac,ap_name) values (
				-2147483648,
				-9223372036854775808,
				'<undefined>'
		    )
        ]]>
    </entry>
    <entry key="addUndefinedGwIfaceDim">
        <![CDATA[
            insert ignore into gw_iface_dim(iface_key,iface_mac,iface_name,iface_phy_name) values (
                -2147483648,
                -9223372036854775808,
                '<undefined>',
                '<undefined>'
            )
        ]]>
    </entry>
    <entry key="insertIntoDateDim">
        <![CDATA[
            insert ignore into network_statistics.date_dim(date) (
                select
                distinct date(aidis.poll_time)
                from network_statistics.aruba_iap_device_info_stg aidis
                left join network_statistics.date_dim dd on date(aidis.poll_time) = dd.date
                where dd.date_key is null
            )
        ]]>
    </entry>
    <entry key="insertIntoTimeDim">
        <![CDATA[
            insert ignore into network_statistics.time_dim(time) (
				select
				distinct time_to_sec(time(aidis.poll_time))
				from network_statistics.aruba_iap_device_info_stg aidis
				left join network_statistics.time_dim td on time_to_sec(time(aidis.poll_time)) = td.time
				where td.time_key is null
			 )
        ]]>
    </entry>
    <entry key="insertIntoTimeDimHourNorm">
        <![CDATA[
            insert ignore into network_statistics.time_dim(time) (
				select
				distinct time_to_sec( date_format(time(aidis.poll_time),'%H:00:00') ) -- not use java escape of % because not formatting string
				from network_statistics.aruba_iap_device_info_stg aidis
				left join network_statistics.time_dim td on time_to_sec(date_format(time(aidis.poll_time),'%H:00:00')) = td.time
				where td.time_key is null
			)
        ]]>
    </entry>
    <entry key="insertIntoDeviceDim">
        <![CDATA[
            insert ignore into network_statistics.device_dim(device_mac,device_name,device_iface_wifi) (
				select
				distinct
				aidis.device_mac,
				aidis.device_name,
				1
				from network_statistics.aruba_iap_device_info_stg aidis
				left join network_statistics.device_dim dd on aidis.device_mac=dd.device_mac
				and aidis.device_name=dd.device_name
				where dd.device_key is null
			)
        ]]>
    </entry>
    <entry key="insertIntoIpDim">
        <![CDATA[
            insert ignore into network_statistics.ip_dim(ipv4,ipv6) (
				select
				distinct
				aidis.device_ip,
				null
				from network_statistics.aruba_iap_device_info_stg aidis
				left join network_statistics.ip_dim id on aidis.device_ip=id.ipv4
				where id.ip_key is null
			)
        ]]>
    </entry>
    <entry key="insertIntoDateDimDateUptimeNorm">
        <![CDATA[
            insert ignore into date_dim(date) (
				select
				distinct
				date(aidi.poll_time - interval aidi.device_uptime_seconds second)
				from aruba_iap_device_info_stg aidi
				left join date_dim dd on date(aidi.poll_time - interval aidi.device_uptime_seconds second)=dd.date
				where dd.date_key is null
			)
        ]]>
    </entry>
    <entry key="insertIntoDateDimTimeUptimeNorm">
        <![CDATA[
            insert ignore into time_dim(time) (
				select
				distinct
				time_to_sec(time(aidi.poll_time - interval aidi.device_uptime_seconds second))
				from aruba_iap_device_info_stg aidi
				left join time_dim td on time_to_sec(time(aidi.poll_time - interval aidi.device_uptime_seconds second))=td.time
				where td.time_key is null
			)
        ]]>
    </entry>

    <!--this step is to normalize device traffic-->
    <entry key="createTempForUpdateFactTableDeviceTrafficByHour">
        create temporary table tmp_device_traffic_by_hour_fact (
            `date` date,
            `time` int,
            `device_mac` bigint,
            `device_name` varchar(255),
            `transmission_bytes_val` bigint
        )
    </entry>
    <entry key="insertTmpFactToTempTableUpdateFactTableDeviceTrafficByHour">
        insert into tmp_device_traffic_by_hour_fact
        values (?,?,?,?,?)
    </entry>
    <entry key="dropTempForUpdateFactTableDeviceTrafficByHour">
        drop table tmp_device_traffic_by_hour_fact
    </entry>
    <entry key="updateFactTableDeviceTrafficByHour">
        <![CDATA[
            insert into network_statistics.device_traffic_by_hour_fact(date_key,time_key,device_key,transmission_bytes) (
                select

                dd.date_key,
                td.time_key,
                dd1.device_key,
                aidi.transmission_bytes_val

                from tmp_device_traffic_by_hour_fact aidi

                join date_dim dd on dd.date_key=(
                    select date_key from
                    date_dim
                    where aidi.date=date
                    order by date_key desc limit 1
                )
                join time_dim td on td.time_key=(
                    select time_key from
                    time_dim
                    where aidi.time=time
                    order by time_key desc limit 1
                )
                join device_dim dd1 on dd1.device_key=(
                    select device_key from
                    device_dim
                    where device_iface_wifi=1 and aidi.device_mac=device_mac and aidi.device_name=device_name
                    order by device_key desc limit 1
                )
			)
			on duplicate key update transmission_bytes=transmission_bytes+transmission_bytes_val
        ]]>
    </entry>

    <!--this step is to get wlan connection-->
    <entry key="createTempForUpdateFactTableDeviceWlanConnections">
        create temporary table tmp_device_wlan_connections_fact (
            `device_mac` bigint,
            `device_name` varchar(255),
            `device_ip` int,
            `device_wlan_mac` bigint,
            `date_connect` date,
            `time_connect` int,
            `connect_status` int
        )
    </entry>
    <entry key="insertTmpFactToTempTableUpdateFactTableDeviceWlanConnections">
        insert into tmp_device_wlan_connections_fact
        values (?,?,?,?,?,?,?)
    </entry>
    <entry key="dropTempForUpdateFactTableDeviceWlanConnections">
        drop table tmp_device_wlan_connections_fact
    </entry>
    <entry key="updateFactTableDeviceWlanConnections">
        <![CDATA[
            insert ignore into device_wlan_connections_fact (
				select

				dd.date_key,
				td.time_key,
				dd1.device_key,
				id.ip_key,
				ad.ap_key,
				gid.iface_key,
				ifnull(vd.vendor_key,-2147483648),
				ifnull(vd1.vendor_key,-2147483648),
				aidi.connect_status

				from tmp_device_wlan_connections_fact aidi

				join date_dim dd on dd.date_key=(
					select date_key from
					date_dim
					where aidi.date_connect=date
					order by date_key desc limit 1
				)
				join time_dim td on td.time_key=(
					select time_key from
					time_dim
					where aidi.time_connect=time
					order by time_key desc limit 1
				)
				join device_dim dd1 on dd1.device_key=(
					select device_key from
					device_dim
					where device_iface_wifi=1 and aidi.device_mac=device_mac and aidi.device_name=device_name
					order by device_key desc limit 1
				)
				join ip_dim id on id.ip_key=(
					select ip_key from
					ip_dim
					where aidi.device_ip=ipv4
					order by ip_key desc limit 1
				)
				join ap_dim ad on ad.ap_key=(
					select ap_key from
					ap_dim
					where ap_key=-2147483648
					order by ap_key desc limit 1
				)
				join gw_iface_dim gid on gid.iface_key=(
					select iface_key from
					gw_iface_dim
					where aidi.device_wlan_mac=iface_mac
					order by iface_key desc limit 1
				)
				left join vendor_dim vd on vd.vendor_key=(
					select vendor_key from
					vendor_dim
					where aidi.device_mac>>24=vendor_prefix
					order by vendor_key desc limit 1
				)
				left join vendor_dim vd1 on vd1.vendor_key=(
					select vendor_key from
					vendor_dim
					where aidi.device_wlan_mac>>24=vendor_prefix
					order by vendor_key desc limit 1
				)
			)
        ]]>
    </entry>

    <entry key="createTempForUpdateFactTableDeviceWlanMetrics">
        create temporary table tmp_device_wlan_metrics_fact (
            `device_mac` bigint,
            `device_name` varchar(255),
            `device_snr` int,
            `date_metric` date,
            `time_metric` int
        )
    </entry>
    <entry key="insertTmpFactToTempTableUpdateFactTableDeviceWlanMetrics">
        insert into tmp_device_wlan_metrics_fact
        values (?,?,?,?,?)
    </entry>
    <entry key="dropTempForUpdateFactTableDeviceWlanMetrics">
        drop table tmp_device_wlan_metrics_fact
    </entry>
    <entry key="updateFactTableDeviceWlanMetrics">
        <![CDATA[
            insert ignore into device_wlan_metrics_fact  (
				select

				dd.date_key,
				td.time_key,
				dd1.device_key,
				aidi.device_snr

				from tmp_device_wlan_metrics_fact aidi

				join date_dim dd on dd.date_key=(
					select date_key from
					date_dim
					where aidi.date_metric=date
					order by date_key desc limit 1
				)

				join time_dim td on td.time_key=(
					select time_key from
					time_dim
					where aidi.time_metric=time
					order by time_key desc limit 1
				)

				join device_dim dd1 on dd1.device_key=(
					select device_key from
					device_dim
					where device_iface_wifi=1 and  aidi.device_mac=device_mac and aidi.device_name=device_name
					order by device_key desc limit 1
				)
			)
        ]]>
    </entry>

    <entry key="createTempForUpdateFactTableDeviceWlanUptime">
        create temporary table tmp_device_wlan_uptime_fact (
            `device_mac` bigint,
            `device_name` varchar(255),
            `device_uptime_seconds` bigint,
            `device_ip` int
        )
    </entry>
    <entry key="insertTmpFactToTempTableUpdateFactTableDeviceWlanUptime">
        insert into tmp_device_wlan_uptime_fact
        values (?,?,?,?)
    </entry>
    <entry key="dropTempForUpdateFactTableDeviceWlanUptime">
        drop table tmp_device_wlan_uptime_fact
    </entry>
    <entry key="updateFactTableDeviceWlanUptime">
        <![CDATA[
            replace into device_wlan_uptime_fact  (
				select

				dd1.device_key,
				id.ip_key,
				aidi.device_uptime_seconds

				from tmp_device_wlan_uptime_fact aidi

				join device_dim dd1 on dd1.device_key=(
					select device_key from
					device_dim
					where device_iface_wifi=1 and aidi.device_mac=device_mac and aidi.device_name=device_name
					order by device_key desc limit 1
				)
				join ip_dim id on id.ip_key=(
					select ip_key from
					ip_dim
					where aidi.device_ip=ipv4
					order by ip_key desc limit 1
				)
			)
        ]]>
    </entry>

    <entry key="getAllStaging">
        <![CDATA[
            select * from aruba_iap_device_info_stg
            order by id -- order id to get increasing time (id is primary key and indexed, ordered, but we want it more explicit)
        ]]>
    </entry>
    <entry key="copyStgToArchive">
        <![CDATA[
            insert into aruba_iap_device_info_archive(poll_time, device_mac, device_wlan_mac, device_ip, device_ap_ip, device_name, device_rx, device_tx, device_snr, device_uptime_seconds)
            select poll_time, device_mac, device_wlan_mac, device_ip, device_ap_ip, device_name, device_rx, device_tx, device_snr, device_uptime_seconds from aruba_iap_device_info_stg
        ]]>
    </entry>

    <!-- following clean up queries should be outside main transaction -->
    <entry key="dropCurrentStg">
        <![CDATA[
            drop table aruba_iap_device_info_stg
        ]]>
    </entry>
    <entry key="createNewStg">
        <![CDATA[
            create table if not exists
            aruba_iap_device_info_stg like aruba_iap_device_info_stg_ingest
        ]]>
    </entry>
    <entry key="moveStgToIngest">
        <![CDATA[
            rename table
            aruba_iap_device_info_stg to tmp,
            aruba_iap_device_info_stg_ingest to aruba_iap_device_info_stg,
            tmp to aruba_iap_device_info_stg_ingest
        ]]>
    </entry>
</properties>