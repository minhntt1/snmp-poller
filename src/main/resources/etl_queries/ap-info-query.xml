<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
    <entry key="insertIntoDateDim">
        <![CDATA[
            insert ignore into date_dim(date) (
                select distinct date(aiis.poll_time)
                from aruba_iap_ap_info_stg aiis
                left join date_dim dd on date(aiis.poll_time) = dd.date
                where dd.date_key is null and aiis.id in %s
            )
        ]]>
    </entry>
    <entry key="insertIntoTimeDim">
        <![CDATA[
            insert ignore into time_dim(time) (
                select distinct time_to_sec(time(aiis.poll_time))
                from aruba_iap_ap_info_stg aiis
                left join time_dim td on time_to_sec(time(aiis.poll_time)) = td.time
                where td.time_key is null and aiis.id in %s
            )
        ]]>
    </entry>
    <entry key="insertIntoIpDim"><![CDATA[
        insert ignore into ip_dim(ipv4) (
            select distinct aiis.ap_ip
            from aruba_iap_ap_info_stg aiis
            left join ip_dim id on aiis.ap_ip = id.ipv4
            where id.ip_key is null and aiis.id in %s
        )
    ]]></entry>
    <entry key="insertIntoApDim">
        <![CDATA[
            insert ignore into ap_dim(ap_mac,ap_name) (
                select distinct aiis.ap_mac, aiis.ap_name
                from aruba_iap_ap_info_stg aiis
                left join ap_dim ad on aiis.ap_mac = ad.ap_mac and aiis.ap_name = ad.ap_name
                where ad.ap_key is null and aiis.id in %s
            )
        ]]>
    </entry>
    <entry key="getListUnprocessed">
        <![CDATA[
            select
            aiais.id
            from aruba_iap_ap_info_stg  aiais
            where aiais.mark=0
            order by aiais.id
            limit 10000
        ]]>
    </entry>
    <entry key="getListProcessed">
        <![CDATA[
            with cte as (
                select
                distinct
                (date(aiais.poll_time)-interval weekday(aiais.poll_time) day) as date,
                aiais.ap_mac,
                aiais.ap_name,
                aiais.ap_ip
                from aruba_iap_ap_info_stg  aiais
                where aiais.id in %s
            )
            select
            id
            from (
                select
                aiais.id,
                row_number() over(partition by date(aiais.poll_time)-interval weekday(aiais.poll_time) day,aiais.ap_mac,aiais.ap_name,aiais.ap_ip order by aiais.poll_time desc,aiais.id desc) as rn
                from (
                    select
                    *
                    from aruba_iap_ap_info_stg
                    where mark=1
                    order by id desc
                    limit 100 -- last 4 hrs
                ) aiais
                where (date(aiais.poll_time)-interval weekday(aiais.poll_time) day,aiais.ap_mac,aiais.ap_name,aiais.ap_ip)
                in (select * from cte)
            ) x
            where x.rn=1
        ]]>
    </entry>
    <entry key="getListUnprocessedForUpdate">
        <![CDATA[
            select
            aiais.id
            from aruba_iap_ap_info_stg  aiais
            where aiais.id in %s and mark=0
            for update
        ]]>
    </entry>
    <entry key="getListProcessedForShare">
        <![CDATA[
            select
            aiais.id
            from aruba_iap_ap_info_stg  aiais
            where aiais.id in %s and mark=1
            for share
        ]]>
    </entry>
    <entry key="updateFactTable">
        <![CDATA[
            -- 4 th step: update fact table
            insert into ap_reboot_cnt_per_week_fact(date_key, ap_key, ip_key, count_reboot) (
                select
                date_key,
                ap_key,
                ip_key,
                sum(cnt) as cnt
                from (
                    select
                    dd.date_key,
                    ad.ap_key,
                    id.ip_key,
                    aiais.ap_uptime_seconds<lag(aiais.ap_uptime_seconds,1,0) over(partition by dd.date_key,ad.ap_key,id.ip_key order by aiais.poll_time,aiais.id) as cnt
                    from aruba_iap_ap_info_stg aiais
                    join date_dim dd on dd.date_key=(
                        select date_key from
                        date_dim
                        where (date(aiais.poll_time)-interval weekday(aiais.poll_time) day)=date
                        order by date_key desc limit 1
                    )
                    join ap_dim ad on ad.ap_key=(
                        select ap_key from
                        ap_dim
                        where aiais.ap_mac=ap_mac and aiais.ap_name=ap_name
                        order by ap_key desc limit 1
                    )
                    join ip_dim id on id.ip_key=(
                        select ip_key from
                        ip_dim
                        where aiais.ap_ip=ipv4
                        order by ip_key desc limit 1
                    )
                    where aiais.id in %s
                ) t
                group by 1,2,3
            )
            on duplicate key update count_reboot=count_reboot+values(count_reboot)
        ]]>
    </entry>
    <entry key="markComplete">
        <![CDATA[
            update aruba_iap_ap_info_stg set mark=1 where id in %s
        ]]>
    </entry>
</properties>