<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
    <entry key="insertIntoDateDim">
        <![CDATA[
            insert ignore into date_dim(date) (
                select distinct date(aiis.poll_time)
                from aruba_iap_ap_info_stg aiis
                left join date_dim dd on date(aiis.poll_time) = dd.date
                where dd.date_key is null
            )
        ]]>
    </entry>
    <entry key="insertIntoWeekDateDim">
        <![CDATA[
            insert ignore into date_dim(date) (
                select distinct date(aiais.poll_time)
                from aruba_iap_ap_info_stg aiais
                left join date_dim dd on (date(aiais.poll_time)-interval weekday(aiais.poll_time) day) = dd.date
                where dd.date_key is null
            )
        ]]>
    </entry>
    <entry key="insertIntoTimeDim">
        <![CDATA[
            insert ignore into time_dim(time) (
                select distinct time_to_sec(time(aiis.poll_time))
                from aruba_iap_ap_info_stg aiis
                left join time_dim td on time_to_sec(time(aiis.poll_time)) = td.time
                where td.time_key is null
            )
        ]]>
    </entry>
    <entry key="insertIntoIpDim">
        <![CDATA[
            insert ignore into ip_dim(ipv4) (
                select distinct aiis.ap_ip
                from aruba_iap_ap_info_stg aiis
                left join ip_dim id on aiis.ap_ip = id.ipv4
                where id.ip_key is null
            )
        ]]>
    </entry>
    <entry key="insertIntoApDim">
        <![CDATA[
            insert ignore into ap_dim(ap_mac,ap_name) (
                select distinct aiis.ap_mac, aiis.ap_name
                from aruba_iap_ap_info_stg aiis
                left join ap_dim ad on aiis.ap_mac = ad.ap_mac and aiis.ap_name = ad.ap_name
                where ad.ap_key is null
            )
        ]]>
    </entry>

    <entry key="createTempForUpdateFactTable">
        create temporary table tmp_ap_reboot_cnt_per_week_fact (
            `ap_week` date,
            `ap_mac` bigint,
            `ap_name` varchar(255),
            `ap_ip` int,
            `reboot_cnt` int
        )
    </entry>
    <entry key="insertTmpFactToTempTableUpdateFactTable">
        insert into tmp_ap_reboot_cnt_per_week_fact
        values (?,?,?,?,?)
    </entry>
    <entry key="dropTempForUpdateFactTable">
        drop table tmp_ap_reboot_cnt_per_week_fact
    </entry>
    <entry key="updateFactTable">
        <![CDATA[
            -- select all data aggregated, etc after app code execution done (values generated by application code)
            -- 4 th step: update fact table

            insert into ap_reboot_cnt_per_week_fact(date_key, ap_key, ip_key, count_reboot) (
                select
                dd.date_key,
                ad.ap_key,
                id.ip_key,
                app_exec_tbl.reboot_cnt -- count reboot (already calculated) in app code, value >= 0

                from tmp_ap_reboot_cnt_per_week_fact app_exec_tbl

                join date_dim dd on dd.date_key=(
                    select date_key from
                    date_dim
                    where app_exec_tbl.ap_week=date
                    order by date_key desc limit 1
                )

                join ap_dim ad on ad.ap_key=(
                    select ap_key from
                    ap_dim
                    where app_exec_tbl.ap_mac=ap_mac and app_exec_tbl.ap_name=ap_name
                    order by ap_key desc limit 1
                )

                join ip_dim id on id.ip_key=(
                    select ip_key from
                    ip_dim
                    where app_exec_tbl.ap_ip=ipv4
                    order by ip_key desc limit 1
                )
            )
            on duplicate key update count_reboot=count_reboot+values(count_reboot)
        ]]>
    </entry>

    <entry key="getAllStaging">
        <![CDATA[
            select * from aruba_iap_ap_info_stg
            order by id -- order id to get increasing time
        ]]>
    </entry>
    <entry key="copyStgToArchive">
        <![CDATA[
            -- specify columns to skip inserting with auto increment columns
            insert into aruba_iap_ap_info_archive(poll_time, ap_mac, ap_name, ap_ip, ap_model, ap_uptime_seconds)
            select poll_time, ap_mac, ap_name, ap_ip, ap_model, ap_uptime_seconds from aruba_iap_ap_info_stg
        ]]>
    </entry>

    <!-- following clean up queries should be outside main transaction -->
    <entry key="dropCurrentStg">
        <![CDATA[
            drop table aruba_iap_ap_info_stg
        ]]>
    </entry>
    <entry key="createNewStg">
        <![CDATA[
            create table if not exists
            aruba_iap_ap_info_stg like aruba_iap_ap_info_stg_ingest
        ]]>
    </entry>
    <entry key="moveStgToIngest">
        <![CDATA[
            rename table
            aruba_iap_ap_info_stg to tmp,
            aruba_iap_ap_info_stg_ingest to aruba_iap_ap_info_stg,
            tmp to aruba_iap_ap_info_stg_ingest
        ]]>
    </entry>
</properties>