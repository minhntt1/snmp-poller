<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
    <entry key="insertIntoGwIfaceDim">
        <![CDATA[
            insert ignore into gw_iface_dim(iface_mac,iface_phy_name) (
                select
                distinct
                rits.if_phys_address,
                rits.if_descr
                from rfc1213_iftable_traffic_stg rits
                left join gw_iface_dim gid on rits.if_phys_address=gid.iface_mac
                and rits.if_descr=gid.iface_phy_name
                where gid.iface_key is null
            )
        ]]>
    </entry>
    <entry key="insertIntoDateDim">
        <![CDATA[
            insert ignore into date_dim(date) (
                select
                distinct
                date(rits.poll_time)
                from rfc1213_iftable_traffic_stg rits
                left join date_dim dd on date(rits.poll_time)=dd.date
                where dd.date_key is null
            );
        ]]>
    </entry>
    <entry key="insertIntoTimeDim">
        <![CDATA[
            insert ignore into time_dim(time) (
                select
                distinct
                time_to_sec(time(rits.poll_time))
                from rfc1213_iftable_traffic_stg rits
                left join time_dim td on time_to_sec(time(rits.poll_time))=td.time
                where td.time_key is null
            )
        ]]>
    </entry>
    <entry key="insertIntoTimeDimHourNorm">
        <![CDATA[
            insert ignore into time_dim(time) (
                select
                distinct time_to_sec(date_format(time(rits.poll_time),'%H:00:00'))
                from rfc1213_iftable_traffic_stg rits
                left join time_dim td on time_to_sec(date_format(time(rits.poll_time),'%H:00:00'))=td.time
                where td.time_key is null
            )
        ]]>
    </entry>
    <entry key="createTempForFact">
        create temporary table tmp_iface_traffic_by_hour_fact (
            `date` date,
            `time` int,
            `if_phys_address` bigint,
            `if_descr` varchar(255),
            `transmission_bytes_val` bigint
        )
    </entry>
    <entry key="insertTmpFactToTempTable">
        insert into tmp_iface_traffic_by_hour_fact
        values (?,?,?,?,?)
    </entry>
    <entry key="dropTempForFact">
        drop table tmp_iface_traffic_by_hour_fact
    </entry>
    <entry key="updateFactTable">
        <![CDATA[
            insert into iface_traffic_by_hour_fact(date_key,time_key,iface_key,transmission_bytes) (
                select

                dd.date_key,
                td.time_key,
                gid.iface_key,
                -- notice: octet = 8 bits = 1 byte
                rits.transmission_bytes_val

                from tmp_iface_traffic_by_hour_fact rits

                join date_dim dd on dd.date_key=(
                    select date_key from
                    date_dim
                    where rits.date=date
                    order by date_key desc limit 1
                )
                join time_dim td on td.time_key=(
                    select time_key from
                    time_dim
                    where rits.time=time
                    order by time_key desc limit 1
                )
                join gw_iface_dim gid on gid.iface_key=(
                    select iface_key from
                    gw_iface_dim
                    where rits.if_phys_address=iface_mac and rits.if_descr=iface_phy_name
                    order by iface_key desc limit 1
                )
            )
            on duplicate key update transmission_bytes=transmission_bytes+transmission_bytes_val
        ]]>
    </entry>

    <entry key="getAllStaging">
        <![CDATA[
            select * from rfc1213_iftable_traffic_stg
            order by id -- order id to get increasing time (id is primary key and indexed, ordered, but we want it more explicit)
        ]]>
    </entry>

    <entry key="copyStgToArchive">
        <![CDATA[
            insert into rfc1213_iftable_traffic_archive(poll_time, if_index, if_descr, if_phys_address, if_admin_status, if_oper_status, if_in_octets, if_out_octets, ip_ad_ent_addr)
            select poll_time, if_index, if_descr, if_phys_address, if_admin_status, if_oper_status, if_in_octets, if_out_octets, ip_ad_ent_addr from rfc1213_iftable_traffic_stg
        ]]>
    </entry>

    <!-- following clean up queries should be outside main transaction -->
    <entry key="dropCurrentStg">
        <![CDATA[
            drop table rfc1213_iftable_traffic_stg
        ]]>
    </entry>
    <entry key="createNewStg">
        <![CDATA[
            create table if not exists
            rfc1213_iftable_traffic_stg like rfc1213_iftable_traffic_stg_ingest
        ]]>
    </entry>
    <entry key="moveStgToIngest">
        <![CDATA[
            rename table
            rfc1213_iftable_traffic_stg to tmp_rfc1213_iftable_traffic_stg,
            rfc1213_iftable_traffic_stg_ingest to rfc1213_iftable_traffic_stg,
            tmp_rfc1213_iftable_traffic_stg to rfc1213_iftable_traffic_stg_ingest
        ]]>
    </entry>
</properties>